import java.util.ArrayList;
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&%%%%%%##%%%%#(#(((((((((((((///((((#(/*//*///((#/********************#%%%%
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&(//**,***********//////****///////(///////*************************/#%%%%%%
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&@@@%#/****,,,,,,,,,,,,,,,,,,****************///*/(/////********************/%%%%%%%%
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&@&%(/,,,,,,,,,,,,,,,,,,.....,...,,,,,,,,,,*******//(/////*******************#%%%%%%%%%
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&@@&%(*,,.,..,,.,,,,,,,,,,,......................,,,,***/**//******************(%%%%%%%%%%%
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/*,,,,,,,,,..,,,,,,,,,,,,,,,,,,,,,................,,,,*********,**********/#%%%%%%%%%%%%
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%(/*,,,........,,,,,*********,,,,,,,,,,,,...............,,,********,,,,,*****/#%%%%%%%%%%#%%
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&(/**,,......,,,*//(((#((###((((((////////*****,,,..... .....,,,,*************/#%##############
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%#/**,,,.....,,/((#####################((((((((///***,,,.........,,,*******,,,*(#################
//&%((#%&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&%/**,,,....,,*/(#%%%%%%%%%###################((((((((///*,,.......,,,,,,**,,**/###################
//@@@@&%&%%#%&%%@@@@@@@@@@@@@@@@@@@@@@@@/***,,....,**(##%%%%%%%%%%%%%%#####################(((((///**,,......,,,,,,,,,*(###################
//@@@@@@@@@@@@#((((&@@@@@@@@@@@@@@@@@&(****,,...,,*/(#%%%%%%%%%%%%%%%%%%####################(((((////**,.....,,,,,,,***((##################
//@@@@@@@@@@@@@@@@&//((##&&@@@@@@@@@@/****,,...,**(##%%&&&&&&%%%%%%%%%%%%%%%%%%##############(((((////**,,....,,,,,,**/(((#################
//@@@@@@@@@@@@@@@@@&%%@@@@@%#((#%&&%#/*****,.....*/(#%%&&&&&&&&%%%%%%%%%%%%%%%%%%%%%%###########((((((///**,......,,,,,*/((((((##############
//@@@@@@@@@@@@@@@@@@@%&@&&&%#%%%#((/******,,...,,/(#%%&&&&&&&&&%%%%%%%%%%%%%%%%%%%%#%############((((((///**,......,,,,**(((((((#############
//@@@@@@@@@@@@@@&%(///////////////*******,,...,**(#%%&&&&&&&&&&%%%%%%%%%%%%%%%%%%%%%#############((((((((//**,,....,,,,,,*(((((((############
//@@@@@@@@@@@@@@@##(////((####/*******,,....,*/#%%&&&&&&&&&&&%%%%%%%%%%%%%%%%%%%%################((((((////**.....,,,,,*//(((((((((########
//@@@@@@@@@@@@@@@@%%%#((#######(*****/**,....,*/(#%&&&&&&&&&&&&&&%%%%%%%%%%%%%%%%%%################(((((((////*,....,,,,,,*/((((((((((#######
//@@@@@@@@@@@@@@@@&%%%&&&&&&&%(*/******,,...,,*((%&&&&&&&&&&&&&&&%%%%%%%%%%%%%%%%%%%%%##############((((((((///*,....,,,,,.,/(((#####((######
//@@@@@@@@@@@@@&&&&&&%%%%###(/***,*****,,...,*/(#%&&&&&&&&&&&&&&&%%%%%%%%%%%%%%%%%%%%%%#############((((((((///*,,....,,,,,.,(((#############
//%####((((//(((((((((((####/*/*,,****,,,..,,*/(#%&&&&&&&&&&&&&%%%%%%%%%%%%%%%%%%%%%%%%%############((((((((///**,....,,,,,,.*/(((###########
///*///////////(##%%%%&&&&&%///,*****,,,...,**/##%%%%%#(/////////((##%%%%%%%%%%%%%%%%%%#####((((((((((((((((////**,....,,,,,.,*/(############
//(((/////**///(##%%%&&&&&&(//*,*****,,.,.,,**(#%%#(////////((((((((((##%%%%%%%%%%%%%#####(////********(((((///***,.....,,,,..,*/(###########
//(////(///////(##%%&&&&&&%((*******,,..,,,,*/(##((((((####%#########(##%%%%%%%%%%%%####(((((((///****,,,*/////***,......,,,...,/((#########(
///((((///((///(##%%&&&&((*,*****,,..,,,,*//(((((/////****//((#########%%%%%%%%##################(((/***,,*//***,.......,,,...,/(########//
//((((///((/*/((##%%&&&&#/*******,..,,,******//(%%%%%%%###(((//***(#####%%%%%%%#########(/**/*/////****,,,,*****,.......,,,....,(((####(///
//(((////((//(((##%%&&&((/******,*//******//(%&&@&&%%##(((((((((((/**(##%%%%#######((/*/#%%%%&%##(((((((///**,,,,......,.,.,,..,/((###(////
//(////(((/*/(((##%%&&&&(##/******#*,,*/**/**/#&&&%%####(*****/////((((///*,,*,,,,,***/(####%###(((((((//(///***//*,..............*((#((/////
//(///((((/*/(((##%%&&&%(#(******/#/*,*%(//*/(#%%###(**,***,,**,**((//(#/**(((((/*,*/(#(((((((////////////////**,,(*,....,,,......,*/////////
////(((##(**(((((#%%%&%###(***/***/,..,(#/**((%###%%%##(//*,,,,*//**///(**((((((//*///(((/*/*,/(/,,.,,,**//////**,*#,....,,,.......,,//*/////
///(((###/*/(((###%%%&%##(/**//***,...,/#/*/#%&%%%#%%#####((((//////((((**(####((/*//(((/**//*,,...,,,,.,*/////***,(,..  .,,........,***/////
//((#####//(%#####%%%##/**///***.....,(//(%&&%%%#########(((((((((((#/*/(#####(//**((((((((((((((###(((////******(...  ............,**/////
//((#####(/(######%%%%###/**///***....,*//(#&&&&&%%%#######((((((((#(((*/((#%%##(//*,*/(((((((((/((///////((//****(*,,.   ...........,**/////
//###%&%#/((#((###%%%%(#(//*///**,....,*///%@@&&&&%%%%%%#############(/*((#%&%%##(//**/(((###((((((((((##((((///**(,,,..    .........,**/////
//#%%%%#((###((%##%%%%(#(//*///**,....,*(#(#@@@&&&%%%%%%%############/*((#%&&%%##((//,*((#############(####((/////*,,,.     ..........,*/////
//%####(//(##((%###%%###(**////**,....,*#&#&@@&&%%%%%%%%%#######%#*/(#&&&&&%%##(((//*,(((#################((((/*,**,..     .........,,*/**/
//#####(//(##((%###%%###(***////**....,*#&@@%(#&&&%%%%%%%%########**((#&&&&%%%%##((((//*,*(########%%%%%####(((/,****,...    .........,,*////
//%%%##///###((%###%%%#((****///**,,..,*#@@@@@%//#%%%%%%%%%###(***((#%%&&&&&%%#####((/////,*(#%%%%%%%%%%%###(*,*//**,,...    ..........,**///
//%%%%(//(#%#((%%##%%%(//****////*,,,,,*%@@@@@@&&%#(/*******////((%&&&&@@@&&%%%%###(((((//////*****////**,,*/((////*,,...   ..........,,,**//
//%%%#(//(%%#((%%##%%#(/////*/////*,,.,*%@@@@@@&&&%%%###(((((/((((&&@&&&&&&%%%###((((((((/////((((((((((((((((((///*,,....  ..........,,,*///
//%%%#(//#%%#((%%##%#(//////*/////*,,,,*%@@@@@@&&%%%%####(((((####%%%(((#%%%###((((////////((((((((#########((((////,,....  .. ........,,**/(
//%%##(((#&%#((%%#/**/((///**//////,,,,*%&@@@@&&&%%%#####(((#####%%%%%%%%%%%%((//*******//(((((((((#########((((///*,........  .. .....,,*/(%
//%%##(((#&(#%%(,,*/((///****////**,.*%&&&@&&&&&%%####(((####%%%%%&&&&%%##((/////////(((((((((((((#######(((((////,... ...... . .....,,*/(#
//%%##((#%&%#(#&%(,,**/////**//***///*.,#&&&&&&&&%%%####(#####%%%%%%%%%%%%##((((((((((((((((((((((((#####((((((///**..   ...... .......,,*/(#
//&%##((#&&%###&%(,,**//////****,**///,,#%&&&&&&&%%%########%%%%%%%%%%%%%%#(((((((((((((((((((#(((((((##((((((////**.   ......    ......***(#
//&%##(##&&%###&&(,***//////*****,,**/**/%%%&&&&&%%######((#%%%%&&%%%%%#######((((((((((((((((((((((((#((((((////***.   ......    ......,**/#
//&%##(#%&&%###&,***//////*****,***////#%%%%%%%%#####(((####((((((((((((((((////////////(((((((((((((((/(((///***,   .....      .......*/*(
//&%####%@&%##%&*****//////*,*,,,,,***/(%%%%%%%%###((((((/***/(##((//**/(/////************//////((((((((((////***.   .....      .. ....,*//
//&%###%&@&%##%&**,**//////*,*,,,,,,***/(%%%%%%%###(((((##%%%%%%%%%######(((((///////***,,,****//((((((((////***,   ......       .. ...,,**
//%%###%&@&%##%&@%*,,***/////*,,*,.,,..,***/#%%%%####(((##%%&&&&&&&&%%##########((((/////////////((((((((////***,,    .... ..        .....,,*
//%###%&&@&%#%%&@%*,,***///****,,,..,,...,**/(#%%%###((((#%&&&&&&&&&&%%%######((((((//////**///((((((((/////***,..    ....   ..       .....,,
//%###%&@@&%#%%&&%*,*****//****,,,..,,......*/(((####((((#%&&&&&&&&&&&%%########(((((((//////(((((((((/////***,.      ....     .        ...,,
//%###%&@@&%#%%&&%*,*****/*****,,,,..,......../##(///((((##&&&&&&&&%%%%######(((((((((///////((((((/////****,..      .....         .........,
//%###%@@@&%#%%&&%***********,,,,.,,...........*#%%%#((((((%&&&&&%%%%###(((((((((((((////////((((//////***,,.         ...  .            ....,
//%##%&@@@%%%%%&&%************,,,................(%%%%%%###(#%%#%%######(((((((((((((/////////((/////***,,..          .              ........
//%%%%&@@@%%%%&&&&*******,,,***,,,................*(%&&%&&&&&&&&%%##(((////((((((((((///////(((////***,,.                              ......
//%%%%&@@@%%%%&&&&******,,,,,,,,,,................,*(%&&&&&&&@@@&&%%%##(////(((((((((//////((////***,,.                               ... ...
//%%%&@@@&%%%%%&&%/****,,,,,.,,,,,,...............,**(#%&&&&@@@@@&&&%%%####(((((((((((((///////***,,.                              ...       
//%%%&@@@#####(/****,,,,,...,,,,.............  .,**(##%&&&&&@@@&&&&%%%#########(((((((//////**,..                                          
//%#%&@@@%##(///*****,,,,........................,**(#%%#%%&&&&&&&&&&%%%%%#######((((((////***,,..                           ..              
//%%%%%#(*,,.,***,,......    .................,,,/(#%%%%%%#%%%&&&&&&%%%%######(((((((///***,,....                                            
//*,,,...,...,,,,. . ...      . ..,,,...,,,,,,,*/#%%%&&&%%%###%%%%%%%######(((((((////***,,......                                            
//......,,,,.,,,..            ....,,,,,,,******/(%%%%&&&%%%%###########((((////////***,,,,,.....                                   ..        
//.................. ..      ... .,***,,,**////(#%%%&&&&&&%%%%###((((((///******,,,,,,,,,,,.....                     .....        .  .       
//....................     .......,*****,,*/(((##%%%&&&&&&&%%%####(((///******,,,,,,,,,,,,,...                    .......... ..  .....       
//...... .............    ....... ,///*****(##%%%%%&&&&&&&%%%%%###(((////***********,,,,,,....                .   .........  .........   ....
//..........    ........  ........,///(///*/#%&&&&&&&&&&&%%%%%%###((((///////******,,,,,,,...               ............ .  .......... ......
//.........       .......  ........*/(((////(%&&&&&&&&&&&%%%%%%###(((((//////******,,,,,,,...         .......................................
public class ShopSystem {
	
	private static ShopSystem instance = new ShopSystem();;
	private ProductController productController;
	private AccountController accountController;
	private TransactionController transactionController;
	private Account currentAccount;
	
	private ShopSystem() {
		productController = ProductController.getInstance();
		accountController = AccountController.getInstance();
	}
	
	public static ShopSystem getInstance() {
		return instance;
	}
	
	public Account getCurrentAccount() {
		return currentAccount;
	}
	
	public void setCurrentAccount(Account account) {
		this.currentAccount = account;
	}
	
	public Account accountLogin(String id, String password) throws NoSuchAccountException {
		Account account = accountController.searchAccountById(id);
		if(account != null) {
			if(!account.login(id, password)) {
				account = null;
			}
		}
		return account;
	}
	
	public boolean accountLogOut() throws AccountIsEmptyException {
		if(currentAccount != null) {
			setCurrentAccount(null);
			return true;
		}
		throw new AccountIsEmptyException();
	}
	
	public boolean registerCompany(Company company) {
		if(!accountController.checkExist(company.getUserID())) {
			accountController.addAccount(company);
			setCurrentAccount(company);
			return true;
		}
		return false;
	}
	
	public boolean registerCustomer(Customer customer) {
		if(!accountController.checkExist(customer.getUserID())) {
			accountController.addAccount(customer);
			setCurrentAccount(customer);
			return true;
		}
		return false;
	}
	
	public void showCurrentAccountTrolley() throws AccountIsNotCustomerException,AccountIsEmptyException {
		if(currentAccountIsCustomer()) {
			ArrayList<TrolleyItem> shoppingTrolley = ((Customer) currentAccount).getTrolley();
			int count = 1;
			System.out.println("Account: " + currentAccount.getName() + " ," + shoppingTrolley.size() + " item(s) in your shopping trolley.");
			for (TrolleyItem item:shoppingTrolley) {
				System.out.println(count + ". " + item.toString());
				count++;
			}
		}
	}
	
	public void showShopProduct(String ShopID) throws AccountIsNotCustomerException,AccountIsEmptyException, NoSuchCompanyException {
		if(currentAccountIsCustomer()) {
			Account company;
			try {
				company = accountController.searchAccountById(ShopID);
				ArrayList<Product> productList = ((Company) company).getProductList();
				System.out.println("Shop ID: " + company.getUserID() + ", " + productList.size() + " products in total.");	
				int count = 1;
				for (Product p:productList) {
					System.out.println(count + ". " + p.toString());
					count++;
				}
			} catch (NoSuchAccountException e) {
				throw new NoSuchCompanyException();
			}
		}
	}
	
	public void showAllShop() throws AccountIsEmptyException, AccountIsNotCustomerException {
		if(currentAccountIsCustomer()) {
			accountController.listAllCompany();
		} 
	}
	
	public boolean addItemToCustomerTrolley(Product product, int quantity, Company company) throws AccountIsEmptyException, AccountIsNotCustomerException {
		if(currentAccountIsCustomer()) {
			ArrayList<TrolleyItem> customerTrolley = ((Customer) currentAccount).getTrolley();
			for (TrolleyItem item:customerTrolley) {
				if(item.getProduct().equals(product))
					item.addQuantity(quantity);
					((Customer) currentAccount).setTrolley(customerTrolley);
					return true;
					
			}
			customerTrolley.add(new TrolleyItem(product, quantity, company));
			((Customer) currentAccount).setTrolley(customerTrolley);
			return true;
		}
		return false;
	}
	
	public boolean removeItemFromTrolley(Product product, int quantity) throws WrongQuantityException, AccountIsEmptyException, AccountIsNotCustomerException {
		if(currentAccountIsCustomer()) {
			ArrayList<TrolleyItem> customerTrolley = ((Customer) currentAccount).getTrolley();
			for (TrolleyItem item : customerTrolley) {
				if(item.getProduct().equals(product)) {
					if(item.getQuantity() == quantity) {
						customerTrolley.remove(item);
						((Customer) currentAccount).setTrolley(customerTrolley);
						return true;
					}else if(item.getQuantity() > quantity)
					{
						int newAmount = item.getQuantity() - quantity;
						item.changeQuantity(newAmount);
						((Customer) currentAccount).setTrolley(customerTrolley);
						return true;
					}else
						throw new WrongQuantityException();
				}
			}
		}
		return false;
			
	}
	
	public Company searchCompanyById(String company) throws NoSuchCompanyException, NoSuchAccountException {
		 return (Company)accountController.searchAccountById(company);
	}
	
	public Product searchProductInCompany(Company company, int pid) throws NoSuchProductException {
		return company.searchProductByPid(pid);
	}

	public boolean currentAccountIsCustomer() throws AccountIsEmptyException, AccountIsNotCustomerException {
		if(currentAccount == null) {
			throw new AccountIsEmptyException();
		}else if (currentAccount instanceof Customer) {
			return true;
		}else {
			throw new AccountIsNotCustomerException();
		}
	}

	public boolean currentAccountIsCompany() throws AccountIsEmptyException, AccountIsNotCompanyException {
		if(currentAccount == null) {
			throw new AccountIsEmptyException();
		}else if (currentAccount instanceof Company) {
			return true;
		}else {
			throw new AccountIsNotCompanyException();
		}
	}

	public boolean createProductForCompany(String productName, double productPrice, int productStock) throws AccountIsEmptyException, AccountIsNotCompanyException {
		if(currentAccountIsCompany()) {
			productController.createProductForCompany(currentAccount, productName, productPrice, productStock);
		}
		return false;
	}

	public boolean depositToCurrentAccount(int amount) throws AccountIsEmptyException, AccountIsNotCustomerException {
		if(currentAccountIsCustomer()) {
			((Customer) currentAccount).deposit(amount);
			return true;
		}
		return false;
	}
	
	public boolean checkout() throws BalanceIsNotEnoughException, NoItemInShoppingTrolleyException, AccountIsEmptyException, AccountIsNotCustomerException {
		if(currentAccountIsCustomer()) {
			transactionController.completeTransaction((Customer) currentAccount);
			return true;
		}
		return false;
	}

}
